{% extends "base.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<div class="container">
    <div class="page-header">
        <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
        <p>Welcome back, <strong>{{ session.username }}</strong></p>
    </div>

    <div class="dashboard-grid">
        <div class="dashboard-card">
            <h3><i class="fas fa-database"></i> My Data</h3>
            {% if user_data %}
                <div class="data-list">
                    {% for data in user_data %}
                        <div class="data-item">
                            <strong>{{ data.data_key }}:</strong> {{ data.data_value }}
                        </div>
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">No data available.</p>
            {% endif %}
        </div>

        <div class="dashboard-card">
            <h3><i class="fas fa-user-circle"></i> Account</h3>
            <div class="action-list">
                <a href="{{ url_for('profile', user_id=session.user_id) }}" class="action-btn">
                    <i class="fas fa-user"></i> View Profile
                </a>
                <a href="/api/user/{{ session.user_id }}" class="action-btn" target="_blank">
                    <i class="fas fa-code"></i> API Data
                </a>
            </div>
        </div>

        <div class="dashboard-card">
            <h3><i class="fas fa-flask"></i> Test API Endpoints</h3>
            <p style="margin-bottom: 1rem; font-size: 0.9rem;">Try accessing these endpoints (you'll need to discover them first by intercepting admin traffic):</p>
            <div class="action-list">
                <button onclick="testEndpoint('/api/admin/settings')" class="action-btn" style="cursor: pointer;">
                    <i class="fas fa-code"></i> Test /api/admin/settings
                </button>
                <button onclick="testEndpoint('/api/admin/keys')" class="action-btn" style="cursor: pointer;">
                    <i class="fas fa-code"></i> Test /api/admin/keys
                </button>
                <button onclick="testEndpoint('/api/admin/users/all')" class="action-btn" style="cursor: pointer;">
                    <i class="fas fa-code"></i> Test /api/admin/users/all
                </button>
            </div>
            <div id="api-result" style="margin-top: 1rem; padding: 1rem; background: var(--dark-bg); border-radius: 6px; display: none;">
                <strong>Response:</strong>
                <pre id="api-result-content" style="margin-top: 0.5rem; overflow-x: auto; font-size: 0.85rem;"></pre>
            </div>
        </div>

        <div class="dashboard-card">
            <h3><i class="fas fa-info-circle"></i> Account Information</h3>
            <div class="detail-item">
                <strong>Role:</strong>
                <span class="badge badge-{{ 'admin' if session.role == 'admin' else 'user' }}">{{ session.role|title }}</span>
            </div>
            <div class="detail-item">
                <strong>User ID:</strong> {{ session.user_id }}
            </div>
        </div>

        <div class="dashboard-card">
            <h3><i class="fas fa-graduation-cap"></i> Course Access</h3>
            <div id="course-status">
                <p>Checking access...</p>
            </div>
            <a href="{{ url_for('course') }}" class="btn btn-primary" style="margin-top: 1rem;">
                <i class="fas fa-book"></i> View Course
            </a>
        </div>
    </div>
</div>

<script>
// Check course access status
fetch('/api/user/paid-status')
    .then(response => response.json())
    .then(data => {
        const statusDiv = document.getElementById('course-status');
        if (data.paid) {
            statusDiv.innerHTML = '<p style="color: #48bb78;"><i class="fas fa-check-circle"></i> Premium Access Active</p>';
        } else {
            statusDiv.innerHTML = '<p style="color: #ed8936;"><i class="fas fa-lock"></i> Free Account - <a href="https://www.paypal.com" target="_blank">Upgrade to Premium</a></p>';
        }
    })
    .catch(error => {
        document.getElementById('course-status').innerHTML = '<p>Error checking status</p>';
    });

function testEndpoint(endpoint) {
    const resultDiv = document.getElementById('api-result');
    const resultContent = document.getElementById('api-result-content');
    
    resultDiv.style.display = 'block';
    resultContent.textContent = 'Loading...';
    
    fetch(endpoint)
        .then(response => {
            return response.json().then(data => ({
                status: response.status,
                statusText: response.statusText,
                data: data
            }));
        })
        .then(result => {
            resultContent.textContent = JSON.stringify(result, null, 2);
            if (result.status === 403) {
                resultContent.style.color = '#ed8936'; // Warning color
            } else if (result.status === 200) {
                resultContent.style.color = '#48bb78'; // Success color
            } else {
                resultContent.style.color = '#f56565'; // Error color
            }
        })
        .catch(error => {
            resultContent.textContent = 'Error: ' + error.message;
            resultContent.style.color = '#f56565';
        });
}
</script>
{% endblock %}

